<!DOCTYPE html>
<!-- saved from url=(0037)http://localhost:4000/pandas_phrases/ -->
<html lang="en" class=" js "><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    

<!-- begin _includes/seo.html --><title>Pandas, Python 慣用句 - Python Cheat Sheet</title>
<meta name="description" content="  table{.toc}データフレームの各列の列名、ユニーク数、型、NaNの数の一覧表を作成する1234df_overview = pd.DataFrame([[i, len(df[i].unique()), df[i].dtypes, df[i].isnull().sum()]     for i in df.columns], columns=[&#39;Feature&#39;, &#39;Unique Values&#39;, &#39;dtypes&#39;, &#39;NaN&#39;])df_overview21人以上にフィルタリングする123   print(df.shape)   df = df[df[&#39;労働者総数&#39;] &gt;= 21]   print(df.shape)NaNの行を取る123   print(df.shape)   df = df[df[&#39;会社数&#39;].isnull() == False]   print(df.shape)データフレームをCSVファイルで書き出す。インデックス値は不要   df.to_csv(&#39;61_法人番号_dup.csv&#39;, encoding=&#39;utf-8&#39;,  index=False)適用事業所番号の列の桁数をチェックする。　最初がゼロの場合、Excel 通してゼロになっている場合があるため 桁数が 10桁のところがあるので、全てを11桁に統一させる 先頭の2桁を抜き出す123456   df[&#39;適用事業所番号&#39;]=df[&#39;適用事業所番号&#39;].astype(str)   df[&#39;length&#39;]=list(map(len,df[&#39;適用事業所番号&#39;]))   df[&#39;length&#39;].value_counts()    s = df[&#39;適用事業所番号&#39;]   df[&#39;適用事業所番号&#39;]=pd.DataFrame(s.str.zfill(11))先頭の2桁を抜き出す　この場合、string なので、それをnumeric に変換する  抜き出した都道府県番号が47個あるか確認する12  df[&#39;都道府県番号&#39;] = df[&#39;適用事業所番号&#39;].str[:2]  df[&#39;都道府県番号&#39;] = pd.to_numeric(df[&#39;都道府県番号&#39;],errors = &#39;coerce&#39; )s.str[2:6]で6桁の申請日のうち、3,4,5,6 を取り出す。　これが mmdd である  df[&#39;日月&#39;] = df[&#39;申請日&#39;].str[2:6]列名 length は不要なので、その列を drop する df = df.drop(columns=[&#39;length&#39;])列名「法人番号」を「会社数」に変更する df.rename(columns={&#39;法人番号&#39;: &#39;会社数&#39;}, inplace = True)列名を指定してデータフレームを再編成する  df = df.loc[:, [&#39;法人番号&#39;, &#39;適用事業所番号&#39;,&#39;法人名&#39;, &#39;住所&#39;, &#39;労働者総数レンジ&#39;, &#39;都道府県名&#39;, &#39;産業大分類名&#39;]]列名「法人名かな」に含まれる全角をなくす  df[&#39;法人名かな&#39;]=df[&#39;法人名かな&#39;].str.replace(&quot;　&quot;, &quot;&quot;)オリジナル６１データに含まれていた列 Unnamed 130 から　139 までを削除する123456789101112df=df.drop(columns=[    &#39;Unnamed: 130&#39;,    &#39;Unnamed: 131&#39;,    &#39;Unnamed: 132&#39;,    &#39;Unnamed: 133&#39;,    &#39;Unnamed: 134&#39;,    &#39;Unnamed: 135&#39;,    &#39;Unnamed: 136&#39;,    &#39;Unnamed: 137&#39;,    &#39;Unnamed: 138&#39;,    &#39;Unnamed: 139&#39;                   ])データフレームの列名を縦にリストする1234pd.options.display.max_rows = 220columns = df.columnscolumns = pd.DataFrame(columns)columns.head(220)抜き出した都道府県番号が47個あるか確認するdf[&#39;都道府県番号&#39;].nunique()法人番号の列内のNaNの総数を出すdf[&#39;法人番号&#39;].isnull().sum()NaN を 9999 で埋める　fillna(9999) で行うdf[&#39;法人番号&#39;]=df[&#39;法人番号&#39;].fillna(9999)申請日の列の型をdatetime 型　dtype(‘&lt;M8[ns]’)にするdf[&#39;申請日&#39;]=pd.to_datetime(df[&#39;申請日&#39;])法人番号で重複排除する123print(df.shape)df.drop_duplicates(subset=&#39;法人番号&#39;, keep=&#39;first&#39;, inplace=True)print(df.shape)法人名の処理する前にオリジナルのデータを取っておくdf[&#39;法人名オリジナル&#39;]=df[&#39;法人名&#39;].copy()法人名についている空白を埋めるdf[&#39;法人名&#39;]=df[&#39;法人名&#39;].str.replace(&quot;　&quot;, &quot;&quot;)SQL DB名：r3_61_227052by137_emp_num_r4.db   SQL Table名： r3_61_227052by137_tab を作成する1234dbname = &#39;r3_61_227052by137_emp_num_r4.db&#39;conn = sqlite3.connect(dbname)cur = conn.cursor()df.to_sql(&#39;r3_61_227052by137_tab&#39;, conn, if_exists=&#39;replace&#39;)SQL ヒアドキュメントサンプル1234567891011121314query = &quot;&quot;&quot;    SELECT             &quot;法人名&quot;,             &quot;都道府県名&quot;,            &quot;労働者総数&quot;,            &quot;産業大分類名&quot;,            &quot;法人番号&quot;    FROM    &quot;r3_61_227052by137_tab&quot;    WHERE   &quot;法人名&quot;     IN      (                &#39;北海道信用金庫&#39;,            &#39;株式会社エスピー工研&#39;            )  &quot;&quot;&quot;SQL ヒアドキュメントメインQuery1234567891011121314151617181920query = &quot;&quot;&quot;    SELECT             &quot;法人名&quot;,             &quot;適用事業所番号&quot;,            &quot;法人番号&quot;,             &quot;住所&quot;,            &quot;定年有無&quot; ,            &quot;定年年齢&quot;,             &quot;継続雇用-希望者最低年齢&quot;,             &quot;労働者総数レンジ&quot;,             &quot;産業大分類名&quot;,             &quot;都道府県名&quot;    FROM    &quot;r3_61_227052by137_tab&quot;    WHERE   &quot;定年有無&quot; == 2 OR            &quot;定年年齢&quot; &gt;= 70 OR            &quot;継続雇用-希望者最低年齢&quot; &gt;= 70 AND            &quot;産業中分類コード&quot; &lt;&gt; 94 AND            &quot;産業中分類コード&quot; &lt;&gt; 97 AND            &quot;産業中分類コード&quot; &lt;&gt; 98    &quot;&quot;&quot;display df のフォーマットを指定する1234567format_dict = { &#39;str%&#39;: &#39;{:.1%}&#39;,               &#39;法人番号&#39;: &#39;{:.0f}&#39;,                &#39;定年到達者総数-65歳未満&#39;: &#39;{:.0f}&#39;,               &#39;定年退職者数（継続雇用希望なし）-65歳未満&#39;: &#39;{:.0f}&#39;,               &#39;継続雇用者数-65歳未満&#39;: &#39;{:.0f}&#39;              }df.style.format(format_dict)SQL query サンプル123456dbname = dbnameconn = sqlite3.connect(dbname)cur = conn.cursor()df = pd.read_sql(query, conn)cur.close()conn.close()Read EXCEL file ファイル名とシート名とIndexとするカラムを指定する。 EXCELにインデクスがない場合は　index_col=None を指定する12xlsx = pd.ExcelFile(&#39;基準データ2023.xlsx&#39;)df = pd.read_excel(xlsx, &#39;data_2023&#39;, index_col=&#39;idx&#39;, header=0)読み込んだdfからヒートマップを作成123plt.rcParams[&#39;figure.figsize&#39;] = 12, 12sns.heatmap(df, annot=True, cmap=&#39;BuGn&#39;)plt.savefig(&#39;employment1.png&#39;)インデックスJoindf12 = df1.join(df2, rsuffix=&#39;_2&#39;)カラム”mean” の値の大きい順 ascending = False でソートするdf = df.sort_values([&quot;mean&quot;], ascending = False)カラム名　産業大分類名で構成比を成型して表示する12345678col_name = &#39;産業大分類名&#39;tab = df[col_name].value_counts()tab = pd.DataFrame(tab)tab = tab.rename_axis(col_name)tab[&#39;構成比&#39;]=(tab[col_name] / tab[col_name].sum())tab.rename(columns={col_name: &#39;会社数&#39;}, inplace = True)format_dict = {&#39;構成比&#39;: &#39;{:.1%}&#39;}display(tab.style.format(format_dict))CSV file read123import codecswith codecs.open(&quot;WA_Fn-UseC_-HR-Employee-Attrition.csv&quot;, mode =&quot;r&quot;, encoding =&quot;utf-8&quot;, errors=&quot;ignore&quot;) as file:    df = pd.read_csv(file, delimiter =&quot;,&quot;, header=0)Count Plot サンプル1234567891011121314151617181920212223242526272829303132import numpy as npimport pandas as pdimport seaborn as sns# matplotlibのグラフをRetinaの高解像度で表示する%config InlineBackend.figure_formats = {&#39;png&#39;, &#39;retina&#39;}# Jupyter Notebookの中で作図した画像を表示させる%matplotlib inline# matplotlib をインポートするimport matplotlib.pyplot as plt# 図のサイズを12inch x 12inch = 864px X 864px にするplt.rcParams[&#39;figure.figsize&#39;] = 12, 12# 日本語タイトルのため、japanizeをインポートするimport japanize_matplotlibplt.rcParams[&#39;font.family&#39;] = &#39;IPAexGothic&#39;# 列を縦にする# plt.xticks(rotation=90)col_name = &#39;YearsAtCompany&#39;sns.countplot(x=col_name, data=df, palette=&#39;hls&#39;)#seaborn countplotを設定し、変数axとしてAnnotationを上書できるようにするax = sns.countplot(x = col_name,                    data = df)# Annotation を設定するfor p in ax.patches:    ax.annotate(format(p.get_height(), &#39;.0f&#39;),                    (p.get_x() + p.get_width() / 2.,                     p.get_height()),                     ha = &#39;center&#39;,                     va = &#39;center&#39;,                     xytext = (0, 9),                     textcoords = &#39;offset points&#39;,                    fontsize = 8,                    color = &#39;blue&#39;)Openpyxl でExcel file のシート名を確認する12345678# ライブラリを読み込むimport openpyxl as xlimport win32com.clientimport osfilename = &#39;61_matching_lisr_winner_1221_v2.xlsx&#39;wb = xl.load_workbook(filename)wb.sheetnamesデータフレーム df, dt を横に結合させるdf = pd.concat([df, dt], axis = 1)都道府県番号；都道府県名を一つの要素としてカラム名「都道府県」部分を、「都道府県番号」と「都道府県名」に分割した新しいデータフレーム「dt」を作成する1234567df[&#39;new&#39;] = df[&#39;都道府県&#39;].str.split(&#39;:&#39;)np_array = df[&#39;new&#39;].valuesnp_list = np_array.tolist()dt = pd.DataFrame(np_list)cols = [&#39;都道府県番号&#39;, &#39;都道府県名&#39;]dt.columns = colsdisplay(dt.head())カラム名「name」をインデクスに変えるdf = df.set_index(&#39;name&#39;)元のインデクス値をインデクスに戻す（リセットする）df = df.reset_index()列間を比較し、その結果を 1\9 で出す1234567891011121314151617181920212223242526272829303132# 必要なモジュールをインポートしますimport numpy as npimport pandas as pd# 演習用のデータフレームを作成します。# ２番目の北海道と宮城県の顧客番号はint型でその他はstr型でデータフレームを作成df = pd.DataFrame({ &#39;社員番号&#39;: [&#39;01285679&#39;, &#39;01340788&#39;, &#39;02123782&#39;, &#39;03541976&#39;, &#39;04297411&#39;, &#39;13299899&#39;, &#39;30144450&#39;, &#39;47339981&#39;],                   &#39;記録 列A&#39;:   [4,3,2,1,4,2,3,8],                   &#39;報告 列B&#39;: [4,3,2,2,4,0,3,8]},                    index=[0, 1, 2, 3, 4, 5, 6,7])# データフレームを表示しますdisplay(df)def func_row_check(row):    &quot;&quot;&quot;    列間を比較する    引数:        row[&#39;col1&#39;]: 比較したい列名 col1        row[&#39;col2&#39;]: 比較したいもう一つの列名 col2    Returns:        1 : 一致        9 : 不一致    &quot;&quot;&quot;    if row[&#39;記録 列A&#39;] == row[&#39;報告 列B&#39;]:        return 1    else:        return 9df[&#39;結果&#39;] = df.apply(func_row_check, axis = 1)display(df)カテゴリ毎に人数出して、整形する123456cat = df[col4].value_counts()cat = pd.DataFrame(cat)cat = cat.rename_axis(col4)cat.rename(columns={col4: &#39;人数&#39;}, inplace = True)display(cat)カテゴリ集計を円グラフにする1234567891011tot = cat.sum()print(tot)sizes = cat[&#39;人数&#39;]labels = cat.index.tolist()fix1, ax1 = plt.subplots()colors = sns.color_palette(&#39;pastel&#39;)[0:9]ax1.pie(sizes, labels=labels, autopct=&#39;%1.1f%%&#39;, startangle=0, colors=colors)ax1.axis(&#39;equal&#39;)ax1.set_title(&#39;申し込み者属性&#39;, pad=4, fontsize=12, color=&#39;black&#39;)plt.show()SPSS データの読み取り　カテゴリカルデータでデータフレームを作成SPSS データは、ラベル名付きとラベル名なし（数値）の二種類をシートを分割して表示しているdf = pd.read_spss(&#39;SPSSデータ20230405.sav&#39;, usecols=None, convert_categoricals=True)SQL here documensquery = &quot;&quot;&quot;    SELECT &quot;法人名&quot;, &quot;適用事業所番号&quot;,&quot;定年年齢&quot;, &quot;継続雇用制度&quot;,&quot;労働者総数&quot;,&quot;労働者総数レンジ&quot;,             &quot;継続雇用-希望者最低年齢&quot;, &quot;継続雇用-基準最高年齢&quot;, &quot;60〜64歳&quot;, &quot;65〜69歳&quot;, &quot;70歳以上&quot;,             &quot;都道府県名&quot;, &quot;都道府県番号&quot;,&quot;産業大分類名&quot;,&quot;産業大分類コード&quot;,&quot;事業具体的内容&quot;    FROM   r4_61_235875by137_tab    WHERE  &quot;適用事業所番号&quot;     IN (            &#39;07040018408&#39;,        &#39;38046133551&#39;,        &#39;19041009509&#39;,        &#39;24031041347&#39;,        &#39;28050009587&#39;,        &#39;03010054500&#39;,        &#39;23090023395&#39;,        &#39;35030028271&#39;,        &#39;47020004572&#39;,        &#39;45032017649&#39;,        &#39;20040019386&#39;,        &#39;41061002192&#39;,        &#39;20040026435&#39;,        &#39;26071017321&#39;,        &#39;23066143807&#39;,        &#39;23044415753&#39;,        &#39;17010005343&#39;,        &#39;17020009844&#39;,        &#39;08011007115&#39;,        &#39;14015254513&#39;,        &#39;13086280459&#39;        ) &quot;&quot;&quot;#dbname = &#39;r4_61_235875by137_0118r5.db&#39;conn = sqlite3.connect(dbname)cur = conn.cursor()# dbをpandasで読み出す。# WHERE で条件に合致した要素のみを読み込み、それをDataFrame に格納するdf1 = pd.read_sql(query, conn)docker グループにユーザ(user)を追加する  $ docker psGot permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.39/containers/json: dial unix /var/run/docker.sock: connect: permission denieduser@KENKYU01:~$ sudo gpasswd -a user sudo[sudo] password for user:Adding user user to group sudodocker conainer  からminimal thema でPublish(bundle exec jekyll server -H 0.0.0.0)する$ winpty docker run --rm -it --name docker_jekyll     -v /$PWD/_config.yml://work/_config.yml     -v /$PWD/index.html://work/index.html     -v /$PWD/_data/://work/_data/     -v /$PWD/_posts/://work/_posts/     -v /$PWD/_site/://work/_site/     -v /$PWD/images/://work/images/     -v /$PWD/assets/://work/assets/     -p 4000:4000     -w //work     docker_jekyll     bundle exec jekyll serve -H 0.0.0.0グループの追加ができたことを確認する。ログアウトすること。user@KENKYU01:~$ id useruid=1000(user) gid=1000(user) groups=1000(user),27(sudo),1001(docker)user@KENKYU01:~$ exitlogoutSQL 文　条件追加 and/or/notformat_dict = { &#39;str%&#39;: &#39;{:.1%}&#39;,               &#39;法人番号&#39;: &#39;{:.0f}&#39; ,               &#39;定年到達者総数-65歳未満&#39;: &#39;{:.0f}&#39;,               &#39;定年退職者数（継続雇用希望なし）-65歳未満&#39;: &#39;{:.0f}&#39;,               &#39;継続雇用者数-65歳未満&#39;: &#39;{:.0f}&#39; }query = &quot;&quot;&quot;    SELECT &quot;法人名&quot;, &quot;適用事業所番号&quot;,&quot;法人番号&quot;, &quot;住所&quot;,&quot;定年有無&quot; ,&quot;定年年齢&quot;, &quot;継続雇用-希望者最低年齢&quot;, &quot;労働者総数レンジ&quot;, &quot;労働者総数&quot; ,&quot;産業大分類名&quot;, &quot;都道府県名&quot;    FROM &quot;r3_61_227051by137_tab&quot;    WHERE &quot;定年有無&quot; == 2 OR    &quot;定年年齢&quot; &gt;= 70 OR    &quot;継続雇用-希望者最低年齢&quot; &gt;= 70 AND    &quot;産業中分類コード&quot; &lt;&gt; 94 AND    &quot;産業中分類コード&quot; &lt;&gt; 97 AND    &quot;産業中分類コード&quot; &lt;&gt; 98  &quot;&quot;&quot;dbname = dbnameconn = sqlite3.connect(dbname)cur = conn.cursor()# dbをpandasで読み出す。df = pd.read_sql(query, conn)cur.close()conn.close()">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Python Cheat Sheet">
<meta property="og:title" content="Pandas, Python 慣用句">
<meta property="og:url" content="http://0.0.0.0:4000/pandas_phrases/">


  <meta property="og:description" content="  table{.toc}データフレームの各列の列名、ユニーク数、型、NaNの数の一覧表を作成する1234df_overview = pd.DataFrame([[i, len(df[i].unique()), df[i].dtypes, df[i].isnull().sum()]     for i in df.columns], columns=[&#39;Feature&#39;, &#39;Unique Values&#39;, &#39;dtypes&#39;, &#39;NaN&#39;])df_overview21人以上にフィルタリングする123   print(df.shape)   df = df[df[&#39;労働者総数&#39;] &gt;= 21]   print(df.shape)NaNの行を取る123   print(df.shape)   df = df[df[&#39;会社数&#39;].isnull() == False]   print(df.shape)データフレームをCSVファイルで書き出す。インデックス値は不要   df.to_csv(&#39;61_法人番号_dup.csv&#39;, encoding=&#39;utf-8&#39;,  index=False)適用事業所番号の列の桁数をチェックする。　最初がゼロの場合、Excel 通してゼロになっている場合があるため 桁数が 10桁のところがあるので、全てを11桁に統一させる 先頭の2桁を抜き出す123456   df[&#39;適用事業所番号&#39;]=df[&#39;適用事業所番号&#39;].astype(str)   df[&#39;length&#39;]=list(map(len,df[&#39;適用事業所番号&#39;]))   df[&#39;length&#39;].value_counts()    s = df[&#39;適用事業所番号&#39;]   df[&#39;適用事業所番号&#39;]=pd.DataFrame(s.str.zfill(11))先頭の2桁を抜き出す　この場合、string なので、それをnumeric に変換する  抜き出した都道府県番号が47個あるか確認する12  df[&#39;都道府県番号&#39;] = df[&#39;適用事業所番号&#39;].str[:2]  df[&#39;都道府県番号&#39;] = pd.to_numeric(df[&#39;都道府県番号&#39;],errors = &#39;coerce&#39; )s.str[2:6]で6桁の申請日のうち、3,4,5,6 を取り出す。　これが mmdd である  df[&#39;日月&#39;] = df[&#39;申請日&#39;].str[2:6]列名 length は不要なので、その列を drop する df = df.drop(columns=[&#39;length&#39;])列名「法人番号」を「会社数」に変更する df.rename(columns={&#39;法人番号&#39;: &#39;会社数&#39;}, inplace = True)列名を指定してデータフレームを再編成する  df = df.loc[:, [&#39;法人番号&#39;, &#39;適用事業所番号&#39;,&#39;法人名&#39;, &#39;住所&#39;, &#39;労働者総数レンジ&#39;, &#39;都道府県名&#39;, &#39;産業大分類名&#39;]]列名「法人名かな」に含まれる全角をなくす  df[&#39;法人名かな&#39;]=df[&#39;法人名かな&#39;].str.replace(&quot;　&quot;, &quot;&quot;)オリジナル６１データに含まれていた列 Unnamed 130 から　139 までを削除する123456789101112df=df.drop(columns=[    &#39;Unnamed: 130&#39;,    &#39;Unnamed: 131&#39;,    &#39;Unnamed: 132&#39;,    &#39;Unnamed: 133&#39;,    &#39;Unnamed: 134&#39;,    &#39;Unnamed: 135&#39;,    &#39;Unnamed: 136&#39;,    &#39;Unnamed: 137&#39;,    &#39;Unnamed: 138&#39;,    &#39;Unnamed: 139&#39;                   ])データフレームの列名を縦にリストする1234pd.options.display.max_rows = 220columns = df.columnscolumns = pd.DataFrame(columns)columns.head(220)抜き出した都道府県番号が47個あるか確認するdf[&#39;都道府県番号&#39;].nunique()法人番号の列内のNaNの総数を出すdf[&#39;法人番号&#39;].isnull().sum()NaN を 9999 で埋める　fillna(9999) で行うdf[&#39;法人番号&#39;]=df[&#39;法人番号&#39;].fillna(9999)申請日の列の型をdatetime 型　dtype(‘&lt;M8[ns]’)にするdf[&#39;申請日&#39;]=pd.to_datetime(df[&#39;申請日&#39;])法人番号で重複排除する123print(df.shape)df.drop_duplicates(subset=&#39;法人番号&#39;, keep=&#39;first&#39;, inplace=True)print(df.shape)法人名の処理する前にオリジナルのデータを取っておくdf[&#39;法人名オリジナル&#39;]=df[&#39;法人名&#39;].copy()法人名についている空白を埋めるdf[&#39;法人名&#39;]=df[&#39;法人名&#39;].str.replace(&quot;　&quot;, &quot;&quot;)SQL DB名：r3_61_227052by137_emp_num_r4.db   SQL Table名： r3_61_227052by137_tab を作成する1234dbname = &#39;r3_61_227052by137_emp_num_r4.db&#39;conn = sqlite3.connect(dbname)cur = conn.cursor()df.to_sql(&#39;r3_61_227052by137_tab&#39;, conn, if_exists=&#39;replace&#39;)SQL ヒアドキュメントサンプル1234567891011121314query = &quot;&quot;&quot;    SELECT             &quot;法人名&quot;,             &quot;都道府県名&quot;,            &quot;労働者総数&quot;,            &quot;産業大分類名&quot;,            &quot;法人番号&quot;    FROM    &quot;r3_61_227052by137_tab&quot;    WHERE   &quot;法人名&quot;     IN      (                &#39;北海道信用金庫&#39;,            &#39;株式会社エスピー工研&#39;            )  &quot;&quot;&quot;SQL ヒアドキュメントメインQuery1234567891011121314151617181920query = &quot;&quot;&quot;    SELECT             &quot;法人名&quot;,             &quot;適用事業所番号&quot;,            &quot;法人番号&quot;,             &quot;住所&quot;,            &quot;定年有無&quot; ,            &quot;定年年齢&quot;,             &quot;継続雇用-希望者最低年齢&quot;,             &quot;労働者総数レンジ&quot;,             &quot;産業大分類名&quot;,             &quot;都道府県名&quot;    FROM    &quot;r3_61_227052by137_tab&quot;    WHERE   &quot;定年有無&quot; == 2 OR            &quot;定年年齢&quot; &gt;= 70 OR            &quot;継続雇用-希望者最低年齢&quot; &gt;= 70 AND            &quot;産業中分類コード&quot; &lt;&gt; 94 AND            &quot;産業中分類コード&quot; &lt;&gt; 97 AND            &quot;産業中分類コード&quot; &lt;&gt; 98    &quot;&quot;&quot;display df のフォーマットを指定する1234567format_dict = { &#39;str%&#39;: &#39;{:.1%}&#39;,               &#39;法人番号&#39;: &#39;{:.0f}&#39;,                &#39;定年到達者総数-65歳未満&#39;: &#39;{:.0f}&#39;,               &#39;定年退職者数（継続雇用希望なし）-65歳未満&#39;: &#39;{:.0f}&#39;,               &#39;継続雇用者数-65歳未満&#39;: &#39;{:.0f}&#39;              }df.style.format(format_dict)SQL query サンプル123456dbname = dbnameconn = sqlite3.connect(dbname)cur = conn.cursor()df = pd.read_sql(query, conn)cur.close()conn.close()Read EXCEL file ファイル名とシート名とIndexとするカラムを指定する。 EXCELにインデクスがない場合は　index_col=None を指定する12xlsx = pd.ExcelFile(&#39;基準データ2023.xlsx&#39;)df = pd.read_excel(xlsx, &#39;data_2023&#39;, index_col=&#39;idx&#39;, header=0)読み込んだdfからヒートマップを作成123plt.rcParams[&#39;figure.figsize&#39;] = 12, 12sns.heatmap(df, annot=True, cmap=&#39;BuGn&#39;)plt.savefig(&#39;employment1.png&#39;)インデックスJoindf12 = df1.join(df2, rsuffix=&#39;_2&#39;)カラム”mean” の値の大きい順 ascending = False でソートするdf = df.sort_values([&quot;mean&quot;], ascending = False)カラム名　産業大分類名で構成比を成型して表示する12345678col_name = &#39;産業大分類名&#39;tab = df[col_name].value_counts()tab = pd.DataFrame(tab)tab = tab.rename_axis(col_name)tab[&#39;構成比&#39;]=(tab[col_name] / tab[col_name].sum())tab.rename(columns={col_name: &#39;会社数&#39;}, inplace = True)format_dict = {&#39;構成比&#39;: &#39;{:.1%}&#39;}display(tab.style.format(format_dict))CSV file read123import codecswith codecs.open(&quot;WA_Fn-UseC_-HR-Employee-Attrition.csv&quot;, mode =&quot;r&quot;, encoding =&quot;utf-8&quot;, errors=&quot;ignore&quot;) as file:    df = pd.read_csv(file, delimiter =&quot;,&quot;, header=0)Count Plot サンプル1234567891011121314151617181920212223242526272829303132import numpy as npimport pandas as pdimport seaborn as sns# matplotlibのグラフをRetinaの高解像度で表示する%config InlineBackend.figure_formats = {&#39;png&#39;, &#39;retina&#39;}# Jupyter Notebookの中で作図した画像を表示させる%matplotlib inline# matplotlib をインポートするimport matplotlib.pyplot as plt# 図のサイズを12inch x 12inch = 864px X 864px にするplt.rcParams[&#39;figure.figsize&#39;] = 12, 12# 日本語タイトルのため、japanizeをインポートするimport japanize_matplotlibplt.rcParams[&#39;font.family&#39;] = &#39;IPAexGothic&#39;# 列を縦にする# plt.xticks(rotation=90)col_name = &#39;YearsAtCompany&#39;sns.countplot(x=col_name, data=df, palette=&#39;hls&#39;)#seaborn countplotを設定し、変数axとしてAnnotationを上書できるようにするax = sns.countplot(x = col_name,                    data = df)# Annotation を設定するfor p in ax.patches:    ax.annotate(format(p.get_height(), &#39;.0f&#39;),                    (p.get_x() + p.get_width() / 2.,                     p.get_height()),                     ha = &#39;center&#39;,                     va = &#39;center&#39;,                     xytext = (0, 9),                     textcoords = &#39;offset points&#39;,                    fontsize = 8,                    color = &#39;blue&#39;)Openpyxl でExcel file のシート名を確認する12345678# ライブラリを読み込むimport openpyxl as xlimport win32com.clientimport osfilename = &#39;61_matching_lisr_winner_1221_v2.xlsx&#39;wb = xl.load_workbook(filename)wb.sheetnamesデータフレーム df, dt を横に結合させるdf = pd.concat([df, dt], axis = 1)都道府県番号；都道府県名を一つの要素としてカラム名「都道府県」部分を、「都道府県番号」と「都道府県名」に分割した新しいデータフレーム「dt」を作成する1234567df[&#39;new&#39;] = df[&#39;都道府県&#39;].str.split(&#39;:&#39;)np_array = df[&#39;new&#39;].valuesnp_list = np_array.tolist()dt = pd.DataFrame(np_list)cols = [&#39;都道府県番号&#39;, &#39;都道府県名&#39;]dt.columns = colsdisplay(dt.head())カラム名「name」をインデクスに変えるdf = df.set_index(&#39;name&#39;)元のインデクス値をインデクスに戻す（リセットする）df = df.reset_index()列間を比較し、その結果を 1\9 で出す1234567891011121314151617181920212223242526272829303132# 必要なモジュールをインポートしますimport numpy as npimport pandas as pd# 演習用のデータフレームを作成します。# ２番目の北海道と宮城県の顧客番号はint型でその他はstr型でデータフレームを作成df = pd.DataFrame({ &#39;社員番号&#39;: [&#39;01285679&#39;, &#39;01340788&#39;, &#39;02123782&#39;, &#39;03541976&#39;, &#39;04297411&#39;, &#39;13299899&#39;, &#39;30144450&#39;, &#39;47339981&#39;],                   &#39;記録 列A&#39;:   [4,3,2,1,4,2,3,8],                   &#39;報告 列B&#39;: [4,3,2,2,4,0,3,8]},                    index=[0, 1, 2, 3, 4, 5, 6,7])# データフレームを表示しますdisplay(df)def func_row_check(row):    &quot;&quot;&quot;    列間を比較する    引数:        row[&#39;col1&#39;]: 比較したい列名 col1        row[&#39;col2&#39;]: 比較したいもう一つの列名 col2    Returns:        1 : 一致        9 : 不一致    &quot;&quot;&quot;    if row[&#39;記録 列A&#39;] == row[&#39;報告 列B&#39;]:        return 1    else:        return 9df[&#39;結果&#39;] = df.apply(func_row_check, axis = 1)display(df)カテゴリ毎に人数出して、整形する123456cat = df[col4].value_counts()cat = pd.DataFrame(cat)cat = cat.rename_axis(col4)cat.rename(columns={col4: &#39;人数&#39;}, inplace = True)display(cat)カテゴリ集計を円グラフにする1234567891011tot = cat.sum()print(tot)sizes = cat[&#39;人数&#39;]labels = cat.index.tolist()fix1, ax1 = plt.subplots()colors = sns.color_palette(&#39;pastel&#39;)[0:9]ax1.pie(sizes, labels=labels, autopct=&#39;%1.1f%%&#39;, startangle=0, colors=colors)ax1.axis(&#39;equal&#39;)ax1.set_title(&#39;申し込み者属性&#39;, pad=4, fontsize=12, color=&#39;black&#39;)plt.show()SPSS データの読み取り　カテゴリカルデータでデータフレームを作成SPSS データは、ラベル名付きとラベル名なし（数値）の二種類をシートを分割して表示しているdf = pd.read_spss(&#39;SPSSデータ20230405.sav&#39;, usecols=None, convert_categoricals=True)SQL here documensquery = &quot;&quot;&quot;    SELECT &quot;法人名&quot;, &quot;適用事業所番号&quot;,&quot;定年年齢&quot;, &quot;継続雇用制度&quot;,&quot;労働者総数&quot;,&quot;労働者総数レンジ&quot;,             &quot;継続雇用-希望者最低年齢&quot;, &quot;継続雇用-基準最高年齢&quot;, &quot;60〜64歳&quot;, &quot;65〜69歳&quot;, &quot;70歳以上&quot;,             &quot;都道府県名&quot;, &quot;都道府県番号&quot;,&quot;産業大分類名&quot;,&quot;産業大分類コード&quot;,&quot;事業具体的内容&quot;    FROM   r4_61_235875by137_tab    WHERE  &quot;適用事業所番号&quot;     IN (            &#39;07040018408&#39;,        &#39;38046133551&#39;,        &#39;19041009509&#39;,        &#39;24031041347&#39;,        &#39;28050009587&#39;,        &#39;03010054500&#39;,        &#39;23090023395&#39;,        &#39;35030028271&#39;,        &#39;47020004572&#39;,        &#39;45032017649&#39;,        &#39;20040019386&#39;,        &#39;41061002192&#39;,        &#39;20040026435&#39;,        &#39;26071017321&#39;,        &#39;23066143807&#39;,        &#39;23044415753&#39;,        &#39;17010005343&#39;,        &#39;17020009844&#39;,        &#39;08011007115&#39;,        &#39;14015254513&#39;,        &#39;13086280459&#39;        ) &quot;&quot;&quot;#dbname = &#39;r4_61_235875by137_0118r5.db&#39;conn = sqlite3.connect(dbname)cur = conn.cursor()# dbをpandasで読み出す。# WHERE で条件に合致した要素のみを読み込み、それをDataFrame に格納するdf1 = pd.read_sql(query, conn)docker グループにユーザ(user)を追加する  $ docker psGot permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.39/containers/json: dial unix /var/run/docker.sock: connect: permission denieduser@KENKYU01:~$ sudo gpasswd -a user sudo[sudo] password for user:Adding user user to group sudodocker conainer  からminimal thema でPublish(bundle exec jekyll server -H 0.0.0.0)する$ winpty docker run --rm -it --name docker_jekyll     -v /$PWD/_config.yml://work/_config.yml     -v /$PWD/index.html://work/index.html     -v /$PWD/_data/://work/_data/     -v /$PWD/_posts/://work/_posts/     -v /$PWD/_site/://work/_site/     -v /$PWD/images/://work/images/     -v /$PWD/assets/://work/assets/     -p 4000:4000     -w //work     docker_jekyll     bundle exec jekyll serve -H 0.0.0.0グループの追加ができたことを確認する。ログアウトすること。user@KENKYU01:~$ id useruid=1000(user) gid=1000(user) groups=1000(user),27(sudo),1001(docker)user@KENKYU01:~$ exitlogoutSQL 文　条件追加 and/or/notformat_dict = { &#39;str%&#39;: &#39;{:.1%}&#39;,               &#39;法人番号&#39;: &#39;{:.0f}&#39; ,               &#39;定年到達者総数-65歳未満&#39;: &#39;{:.0f}&#39;,               &#39;定年退職者数（継続雇用希望なし）-65歳未満&#39;: &#39;{:.0f}&#39;,               &#39;継続雇用者数-65歳未満&#39;: &#39;{:.0f}&#39; }query = &quot;&quot;&quot;    SELECT &quot;法人名&quot;, &quot;適用事業所番号&quot;,&quot;法人番号&quot;, &quot;住所&quot;,&quot;定年有無&quot; ,&quot;定年年齢&quot;, &quot;継続雇用-希望者最低年齢&quot;, &quot;労働者総数レンジ&quot;, &quot;労働者総数&quot; ,&quot;産業大分類名&quot;, &quot;都道府県名&quot;    FROM &quot;r3_61_227051by137_tab&quot;    WHERE &quot;定年有無&quot; == 2 OR    &quot;定年年齢&quot; &gt;= 70 OR    &quot;継続雇用-希望者最低年齢&quot; &gt;= 70 AND    &quot;産業中分類コード&quot; &lt;&gt; 94 AND    &quot;産業中分類コード&quot; &lt;&gt; 97 AND    &quot;産業中分類コード&quot; &lt;&gt; 98  &quot;&quot;&quot;dbname = dbnameconn = sqlite3.connect(dbname)cur = conn.cursor()# dbをpandasで読み出す。df = pd.read_sql(query, conn)cur.close()conn.close()">







  <meta property="article:published_time" content="2023-04-25T00:00:00+00:00">





  

  


<link rel="canonical" href="http://0.0.0.0:4000/pandas_phrases/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "so-wi.com",
      "url": "http://0.0.0.0:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Python Cheat Sheet Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="./Pandas, Python 慣用句_files/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  <style id="fit-vids-style">.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}</style></head>

  <body class="layout--splash landing dark-theme" style="margin-bottom: 220.201px;">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="http://localhost:4000/">Python Cheat Sheet</a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button" count="0" style="">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      

<div id="main" role="main">
  <article class="splash" itemscope="" itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Pandas, Python 慣用句">
    <meta itemprop="description" content="  table{.toc}データフレームの各列の列名、ユニーク数、型、NaNの数の一覧表を作成する1234df_overview = pd.DataFrame([[i, len(df[i].unique()), df[i].dtypes, df[i].isnull().sum()]     for i in df.columns], columns=[&#39;Feature&#39;, &#39;Unique Values&#39;, &#39;dtypes&#39;, &#39;NaN&#39;])df_overview21人以上にフィルタリングする123   print(df.shape)   df = df[df[&#39;労働者総数&#39;] &gt;= 21]   print(df.shape)NaNの行を取る123   print(df.shape)   df = df[df[&#39;会社数&#39;].isnull() == False]   print(df.shape)データフレームをCSVファイルで書き出す。インデックス値は不要   df.to_csv(&#39;61_法人番号_dup.csv&#39;, encoding=&#39;utf-8&#39;,  index=False)適用事業所番号の列の桁数をチェックする。　最初がゼロの場合、Excel 通してゼロになっている場合があるため 桁数が 10桁のところがあるので、全てを11桁に統一させる 先頭の2桁を抜き出す123456   df[&#39;適用事業所番号&#39;]=df[&#39;適用事業所番号&#39;].astype(str)   df[&#39;length&#39;]=list(map(len,df[&#39;適用事業所番号&#39;]))   df[&#39;length&#39;].value_counts()    s = df[&#39;適用事業所番号&#39;]   df[&#39;適用事業所番号&#39;]=pd.DataFrame(s.str.zfill(11))先頭の2桁を抜き出す　この場合、string なので、それをnumeric に変換する  抜き出した都道府県番号が47個あるか確認する12  df[&#39;都道府県番号&#39;] = df[&#39;適用事業所番号&#39;].str[:2]  df[&#39;都道府県番号&#39;] = pd.to_numeric(df[&#39;都道府県番号&#39;],errors = &#39;coerce&#39; )s.str[2:6]で6桁の申請日のうち、3,4,5,6 を取り出す。　これが mmdd である  df[&#39;日月&#39;] = df[&#39;申請日&#39;].str[2:6]列名 length は不要なので、その列を drop する df = df.drop(columns=[&#39;length&#39;])列名「法人番号」を「会社数」に変更する df.rename(columns={&#39;法人番号&#39;: &#39;会社数&#39;}, inplace = True)列名を指定してデータフレームを再編成する  df = df.loc[:, [&#39;法人番号&#39;, &#39;適用事業所番号&#39;,&#39;法人名&#39;, &#39;住所&#39;, &#39;労働者総数レンジ&#39;, &#39;都道府県名&#39;, &#39;産業大分類名&#39;]]列名「法人名かな」に含まれる全角をなくす  df[&#39;法人名かな&#39;]=df[&#39;法人名かな&#39;].str.replace(&quot;　&quot;, &quot;&quot;)オリジナル６１データに含まれていた列 Unnamed 130 から　139 までを削除する123456789101112df=df.drop(columns=[    &#39;Unnamed: 130&#39;,    &#39;Unnamed: 131&#39;,    &#39;Unnamed: 132&#39;,    &#39;Unnamed: 133&#39;,    &#39;Unnamed: 134&#39;,    &#39;Unnamed: 135&#39;,    &#39;Unnamed: 136&#39;,    &#39;Unnamed: 137&#39;,    &#39;Unnamed: 138&#39;,    &#39;Unnamed: 139&#39;                   ])データフレームの列名を縦にリストする1234pd.options.display.max_rows = 220columns = df.columnscolumns = pd.DataFrame(columns)columns.head(220)抜き出した都道府県番号が47個あるか確認するdf[&#39;都道府県番号&#39;].nunique()法人番号の列内のNaNの総数を出すdf[&#39;法人番号&#39;].isnull().sum()NaN を 9999 で埋める　fillna(9999) で行うdf[&#39;法人番号&#39;]=df[&#39;法人番号&#39;].fillna(9999)申請日の列の型をdatetime 型　dtype(‘&lt;M8[ns]’)にするdf[&#39;申請日&#39;]=pd.to_datetime(df[&#39;申請日&#39;])法人番号で重複排除する123print(df.shape)df.drop_duplicates(subset=&#39;法人番号&#39;, keep=&#39;first&#39;, inplace=True)print(df.shape)法人名の処理する前にオリジナルのデータを取っておくdf[&#39;法人名オリジナル&#39;]=df[&#39;法人名&#39;].copy()法人名についている空白を埋めるdf[&#39;法人名&#39;]=df[&#39;法人名&#39;].str.replace(&quot;　&quot;, &quot;&quot;)SQL DB名：r3_61_227052by137_emp_num_r4.db   SQL Table名： r3_61_227052by137_tab を作成する1234dbname = &#39;r3_61_227052by137_emp_num_r4.db&#39;conn = sqlite3.connect(dbname)cur = conn.cursor()df.to_sql(&#39;r3_61_227052by137_tab&#39;, conn, if_exists=&#39;replace&#39;)SQL ヒアドキュメントサンプル1234567891011121314query = &quot;&quot;&quot;    SELECT             &quot;法人名&quot;,             &quot;都道府県名&quot;,            &quot;労働者総数&quot;,            &quot;産業大分類名&quot;,            &quot;法人番号&quot;    FROM    &quot;r3_61_227052by137_tab&quot;    WHERE   &quot;法人名&quot;     IN      (                &#39;北海道信用金庫&#39;,            &#39;株式会社エスピー工研&#39;            )  &quot;&quot;&quot;SQL ヒアドキュメントメインQuery1234567891011121314151617181920query = &quot;&quot;&quot;    SELECT             &quot;法人名&quot;,             &quot;適用事業所番号&quot;,            &quot;法人番号&quot;,             &quot;住所&quot;,            &quot;定年有無&quot; ,            &quot;定年年齢&quot;,             &quot;継続雇用-希望者最低年齢&quot;,             &quot;労働者総数レンジ&quot;,             &quot;産業大分類名&quot;,             &quot;都道府県名&quot;    FROM    &quot;r3_61_227052by137_tab&quot;    WHERE   &quot;定年有無&quot; == 2 OR            &quot;定年年齢&quot; &gt;= 70 OR            &quot;継続雇用-希望者最低年齢&quot; &gt;= 70 AND            &quot;産業中分類コード&quot; &lt;&gt; 94 AND            &quot;産業中分類コード&quot; &lt;&gt; 97 AND            &quot;産業中分類コード&quot; &lt;&gt; 98    &quot;&quot;&quot;display df のフォーマットを指定する1234567format_dict = { &#39;str%&#39;: &#39;{:.1%}&#39;,               &#39;法人番号&#39;: &#39;{:.0f}&#39;,                &#39;定年到達者総数-65歳未満&#39;: &#39;{:.0f}&#39;,               &#39;定年退職者数（継続雇用希望なし）-65歳未満&#39;: &#39;{:.0f}&#39;,               &#39;継続雇用者数-65歳未満&#39;: &#39;{:.0f}&#39;              }df.style.format(format_dict)SQL query サンプル123456dbname = dbnameconn = sqlite3.connect(dbname)cur = conn.cursor()df = pd.read_sql(query, conn)cur.close()conn.close()Read EXCEL file ファイル名とシート名とIndexとするカラムを指定する。 EXCELにインデクスがない場合は　index_col=None を指定する12xlsx = pd.ExcelFile(&#39;基準データ2023.xlsx&#39;)df = pd.read_excel(xlsx, &#39;data_2023&#39;, index_col=&#39;idx&#39;, header=0)読み込んだdfからヒートマップを作成123plt.rcParams[&#39;figure.figsize&#39;] = 12, 12sns.heatmap(df, annot=True, cmap=&#39;BuGn&#39;)plt.savefig(&#39;employment1.png&#39;)インデックスJoindf12 = df1.join(df2, rsuffix=&#39;_2&#39;)カラム”mean” の値の大きい順 ascending = False でソートするdf = df.sort_values([&quot;mean&quot;], ascending = False)カラム名　産業大分類名で構成比を成型して表示する12345678col_name = &#39;産業大分類名&#39;tab = df[col_name].value_counts()tab = pd.DataFrame(tab)tab = tab.rename_axis(col_name)tab[&#39;構成比&#39;]=(tab[col_name] / tab[col_name].sum())tab.rename(columns={col_name: &#39;会社数&#39;}, inplace = True)format_dict = {&#39;構成比&#39;: &#39;{:.1%}&#39;}display(tab.style.format(format_dict))CSV file read123import codecswith codecs.open(&quot;WA_Fn-UseC_-HR-Employee-Attrition.csv&quot;, mode =&quot;r&quot;, encoding =&quot;utf-8&quot;, errors=&quot;ignore&quot;) as file:    df = pd.read_csv(file, delimiter =&quot;,&quot;, header=0)Count Plot サンプル1234567891011121314151617181920212223242526272829303132import numpy as npimport pandas as pdimport seaborn as sns# matplotlibのグラフをRetinaの高解像度で表示する%config InlineBackend.figure_formats = {&#39;png&#39;, &#39;retina&#39;}# Jupyter Notebookの中で作図した画像を表示させる%matplotlib inline# matplotlib をインポートするimport matplotlib.pyplot as plt# 図のサイズを12inch x 12inch = 864px X 864px にするplt.rcParams[&#39;figure.figsize&#39;] = 12, 12# 日本語タイトルのため、japanizeをインポートするimport japanize_matplotlibplt.rcParams[&#39;font.family&#39;] = &#39;IPAexGothic&#39;# 列を縦にする# plt.xticks(rotation=90)col_name = &#39;YearsAtCompany&#39;sns.countplot(x=col_name, data=df, palette=&#39;hls&#39;)#seaborn countplotを設定し、変数axとしてAnnotationを上書できるようにするax = sns.countplot(x = col_name,                    data = df)# Annotation を設定するfor p in ax.patches:    ax.annotate(format(p.get_height(), &#39;.0f&#39;),                    (p.get_x() + p.get_width() / 2.,                     p.get_height()),                     ha = &#39;center&#39;,                     va = &#39;center&#39;,                     xytext = (0, 9),                     textcoords = &#39;offset points&#39;,                    fontsize = 8,                    color = &#39;blue&#39;)Openpyxl でExcel file のシート名を確認する12345678# ライブラリを読み込むimport openpyxl as xlimport win32com.clientimport osfilename = &#39;61_matching_lisr_winner_1221_v2.xlsx&#39;wb = xl.load_workbook(filename)wb.sheetnamesデータフレーム df, dt を横に結合させるdf = pd.concat([df, dt], axis = 1)都道府県番号；都道府県名を一つの要素としてカラム名「都道府県」部分を、「都道府県番号」と「都道府県名」に分割した新しいデータフレーム「dt」を作成する1234567df[&#39;new&#39;] = df[&#39;都道府県&#39;].str.split(&#39;:&#39;)np_array = df[&#39;new&#39;].valuesnp_list = np_array.tolist()dt = pd.DataFrame(np_list)cols = [&#39;都道府県番号&#39;, &#39;都道府県名&#39;]dt.columns = colsdisplay(dt.head())カラム名「name」をインデクスに変えるdf = df.set_index(&#39;name&#39;)元のインデクス値をインデクスに戻す（リセットする）df = df.reset_index()列間を比較し、その結果を 1\9 で出す1234567891011121314151617181920212223242526272829303132# 必要なモジュールをインポートしますimport numpy as npimport pandas as pd# 演習用のデータフレームを作成します。# ２番目の北海道と宮城県の顧客番号はint型でその他はstr型でデータフレームを作成df = pd.DataFrame({ &#39;社員番号&#39;: [&#39;01285679&#39;, &#39;01340788&#39;, &#39;02123782&#39;, &#39;03541976&#39;, &#39;04297411&#39;, &#39;13299899&#39;, &#39;30144450&#39;, &#39;47339981&#39;],                   &#39;記録 列A&#39;:   [4,3,2,1,4,2,3,8],                   &#39;報告 列B&#39;: [4,3,2,2,4,0,3,8]},                    index=[0, 1, 2, 3, 4, 5, 6,7])# データフレームを表示しますdisplay(df)def func_row_check(row):    &quot;&quot;&quot;    列間を比較する    引数:        row[&#39;col1&#39;]: 比較したい列名 col1        row[&#39;col2&#39;]: 比較したいもう一つの列名 col2    Returns:        1 : 一致        9 : 不一致    &quot;&quot;&quot;    if row[&#39;記録 列A&#39;] == row[&#39;報告 列B&#39;]:        return 1    else:        return 9df[&#39;結果&#39;] = df.apply(func_row_check, axis = 1)display(df)カテゴリ毎に人数出して、整形する123456cat = df[col4].value_counts()cat = pd.DataFrame(cat)cat = cat.rename_axis(col4)cat.rename(columns={col4: &#39;人数&#39;}, inplace = True)display(cat)カテゴリ集計を円グラフにする1234567891011tot = cat.sum()print(tot)sizes = cat[&#39;人数&#39;]labels = cat.index.tolist()fix1, ax1 = plt.subplots()colors = sns.color_palette(&#39;pastel&#39;)[0:9]ax1.pie(sizes, labels=labels, autopct=&#39;%1.1f%%&#39;, startangle=0, colors=colors)ax1.axis(&#39;equal&#39;)ax1.set_title(&#39;申し込み者属性&#39;, pad=4, fontsize=12, color=&#39;black&#39;)plt.show()SPSS データの読み取り　カテゴリカルデータでデータフレームを作成SPSS データは、ラベル名付きとラベル名なし（数値）の二種類をシートを分割して表示しているdf = pd.read_spss(&#39;SPSSデータ20230405.sav&#39;, usecols=None, convert_categoricals=True)SQL here documensquery = &quot;&quot;&quot;    SELECT &quot;法人名&quot;, &quot;適用事業所番号&quot;,&quot;定年年齢&quot;, &quot;継続雇用制度&quot;,&quot;労働者総数&quot;,&quot;労働者総数レンジ&quot;,             &quot;継続雇用-希望者最低年齢&quot;, &quot;継続雇用-基準最高年齢&quot;, &quot;60〜64歳&quot;, &quot;65〜69歳&quot;, &quot;70歳以上&quot;,             &quot;都道府県名&quot;, &quot;都道府県番号&quot;,&quot;産業大分類名&quot;,&quot;産業大分類コード&quot;,&quot;事業具体的内容&quot;    FROM   r4_61_235875by137_tab    WHERE  &quot;適用事業所番号&quot;     IN (            &#39;07040018408&#39;,        &#39;38046133551&#39;,        &#39;19041009509&#39;,        &#39;24031041347&#39;,        &#39;28050009587&#39;,        &#39;03010054500&#39;,        &#39;23090023395&#39;,        &#39;35030028271&#39;,        &#39;47020004572&#39;,        &#39;45032017649&#39;,        &#39;20040019386&#39;,        &#39;41061002192&#39;,        &#39;20040026435&#39;,        &#39;26071017321&#39;,        &#39;23066143807&#39;,        &#39;23044415753&#39;,        &#39;17010005343&#39;,        &#39;17020009844&#39;,        &#39;08011007115&#39;,        &#39;14015254513&#39;,        &#39;13086280459&#39;        ) &quot;&quot;&quot;#dbname = &#39;r4_61_235875by137_0118r5.db&#39;conn = sqlite3.connect(dbname)cur = conn.cursor()# dbをpandasで読み出す。# WHERE で条件に合致した要素のみを読み込み、それをDataFrame に格納するdf1 = pd.read_sql(query, conn)docker グループにユーザ(user)を追加する  $ docker psGot permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.39/containers/json: dial unix /var/run/docker.sock: connect: permission denieduser@KENKYU01:~$ sudo gpasswd -a user sudo[sudo] password for user:Adding user user to group sudodocker conainer  からminimal thema でPublish(bundle exec jekyll server -H 0.0.0.0)する$ winpty docker run --rm -it --name docker_jekyll     -v /$PWD/_config.yml://work/_config.yml     -v /$PWD/index.html://work/index.html     -v /$PWD/_data/://work/_data/     -v /$PWD/_posts/://work/_posts/     -v /$PWD/_site/://work/_site/     -v /$PWD/images/://work/images/     -v /$PWD/assets/://work/assets/     -p 4000:4000     -w //work     docker_jekyll     bundle exec jekyll serve -H 0.0.0.0グループの追加ができたことを確認する。ログアウトすること。user@KENKYU01:~$ id useruid=1000(user) gid=1000(user) groups=1000(user),27(sudo),1001(docker)user@KENKYU01:~$ exitlogoutSQL 文　条件追加 and/or/notformat_dict = { &#39;str%&#39;: &#39;{:.1%}&#39;,               &#39;法人番号&#39;: &#39;{:.0f}&#39; ,               &#39;定年到達者総数-65歳未満&#39;: &#39;{:.0f}&#39;,               &#39;定年退職者数（継続雇用希望なし）-65歳未満&#39;: &#39;{:.0f}&#39;,               &#39;継続雇用者数-65歳未満&#39;: &#39;{:.0f}&#39; }query = &quot;&quot;&quot;    SELECT &quot;法人名&quot;, &quot;適用事業所番号&quot;,&quot;法人番号&quot;, &quot;住所&quot;,&quot;定年有無&quot; ,&quot;定年年齢&quot;, &quot;継続雇用-希望者最低年齢&quot;, &quot;労働者総数レンジ&quot;, &quot;労働者総数&quot; ,&quot;産業大分類名&quot;, &quot;都道府県名&quot;    FROM &quot;r3_61_227051by137_tab&quot;    WHERE &quot;定年有無&quot; == 2 OR    &quot;定年年齢&quot; &gt;= 70 OR    &quot;継続雇用-希望者最低年齢&quot; &gt;= 70 AND    &quot;産業中分類コード&quot; &lt;&gt; 94 AND    &quot;産業中分類コード&quot; &lt;&gt; 97 AND    &quot;産業中分類コード&quot; &lt;&gt; 98  &quot;&quot;&quot;dbname = dbnameconn = sqlite3.connect(dbname)cur = conn.cursor()# dbをpandasで読み出す。df = pd.read_sql(query, conn)cur.close()conn.close()">
    <meta itemprop="datePublished" content="April 25, 2023">
    

    <section class="page__content" itemprop="text">
      <ul>
  <li>table
{.toc}</li>
</ul>

<h3 id="データフレームの各列の列名ユニーク数型nanの数の一覧表を作成する">データフレームの各列の列名、ユニーク数、型、NaNの数の一覧表を作成する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">df_overview</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">unique</span><span class="p">()),</span> <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isnull</span><span class="p">().</span><span class="nb">sum</span><span class="p">()]</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'Feature'</span><span class="p">,</span> <span class="s">'Unique Values'</span><span class="p">,</span> <span class="s">'dtypes'</span><span class="p">,</span> <span class="s">'NaN'</span><span class="p">])</span>

<span class="n">df_overview</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="21人以上にフィルタリングする">21人以上にフィルタリングする</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre>   <span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
   <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">'労働者総数'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">21</span><span class="p">]</span>
   <span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="nanの行を取る">NaNの行を取る</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre>   <span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
   <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">'会社数'</span><span class="p">].</span><span class="n">isnull</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span><span class="p">]</span>
   <span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="データフレームをcsvファイルで書き出すインデックス値は不要">データフレームをCSVファイルで書き出す。インデックス値は不要</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python">   <span class="n">df</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'61_法人番号_dup.csv'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">,</span>  <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></code></pre></figure>

<h3 id="適用事業所番号の列の桁数をチェックする最初がゼロの場合excel-通してゼロになっている場合があるため-桁数が-10桁のところがあるので全てを11桁に統一させる-先頭の2桁を抜き出す">適用事業所番号の列の桁数をチェックする。　最初がゼロの場合、Excel 通してゼロになっている場合があるため 桁数が 10桁のところがあるので、全てを11桁に統一させる 先頭の2桁を抜き出す</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre>   <span class="n">df</span><span class="p">[</span><span class="s">'適用事業所番号'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'適用事業所番号'</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
   <span class="n">df</span><span class="p">[</span><span class="s">'length'</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span><span class="n">df</span><span class="p">[</span><span class="s">'適用事業所番号'</span><span class="p">]))</span>
   <span class="n">df</span><span class="p">[</span><span class="s">'length'</span><span class="p">].</span><span class="n">value_counts</span><span class="p">()</span>
 
   <span class="n">s</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'適用事業所番号'</span><span class="p">]</span>
   <span class="n">df</span><span class="p">[</span><span class="s">'適用事業所番号'</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">11</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="先頭の2桁を抜き出すこの場合string-なのでそれをnumeric-に変換する--抜き出した都道府県番号が47個あるか確認する">先頭の2桁を抜き出す　この場合、string なので、それをnumeric に変換する  抜き出した都道府県番号が47個あるか確認する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre>  <span class="n">df</span><span class="p">[</span><span class="s">'都道府県番号'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'適用事業所番号'</span><span class="p">].</span><span class="nb">str</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
  <span class="n">df</span><span class="p">[</span><span class="s">'都道府県番号'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'都道府県番号'</span><span class="p">],</span><span class="n">errors</span> <span class="o">=</span> <span class="s">'coerce'</span> <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="sstr26で6桁の申請日のうち3456-を取り出すこれが-mmdd-である">s.str[2:6]で6桁の申請日のうち、3,4,5,6 を取り出す。　これが mmdd である</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python">  <span class="n">df</span><span class="p">[</span><span class="s">'日月'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'申請日'</span><span class="p">].</span><span class="nb">str</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span></code></pre></figure>

<h3 id="列名-length-は不要なのでその列を-drop-する">列名 length は不要なので、その列を drop する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"> <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'length'</span><span class="p">])</span></code></pre></figure>

<h3 id="列名法人番号を会社数に変更する">列名「法人番号」を「会社数」に変更する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"> <span class="n">df</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'法人番号'</span><span class="p">:</span> <span class="s">'会社数'</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span></code></pre></figure>

<h3 id="列名を指定してデータフレームを再編成する">列名を指定してデータフレームを再編成する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python">  <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s">'法人番号'</span><span class="p">,</span> <span class="s">'適用事業所番号'</span><span class="p">,</span><span class="s">'法人名'</span><span class="p">,</span> <span class="s">'住所'</span><span class="p">,</span> <span class="s">'労働者総数レンジ'</span><span class="p">,</span> <span class="s">'都道府県名'</span><span class="p">,</span> <span class="s">'産業大分類名'</span><span class="p">]]</span></code></pre></figure>

<h3 id="列名法人名かなに含まれる全角をなくす">列名「法人名かな」に含まれる全角をなくす</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python">  <span class="n">df</span><span class="p">[</span><span class="s">'法人名かな'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'法人名かな'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"　"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span></code></pre></figure>

<h3 id="オリジナル６１データに含まれていた列-unnamed-130-から139-までを削除する">オリジナル６１データに含まれていた列 Unnamed 130 から　139 までを削除する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span>
    <span class="s">'Unnamed: 130'</span><span class="p">,</span>
    <span class="s">'Unnamed: 131'</span><span class="p">,</span>
    <span class="s">'Unnamed: 132'</span><span class="p">,</span>
    <span class="s">'Unnamed: 133'</span><span class="p">,</span>
    <span class="s">'Unnamed: 134'</span><span class="p">,</span>
    <span class="s">'Unnamed: 135'</span><span class="p">,</span>
    <span class="s">'Unnamed: 136'</span><span class="p">,</span>
    <span class="s">'Unnamed: 137'</span><span class="p">,</span>
    <span class="s">'Unnamed: 138'</span><span class="p">,</span>
    <span class="s">'Unnamed: 139'</span>
                   <span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="データフレームの列名を縦にリストする">データフレームの列名を縦にリストする</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">pd</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">220</span>
<span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">columns</span>
<span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
<span class="n">columns</span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="mi">220</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="抜き出した都道府県番号が47個あるか確認する">抜き出した都道府県番号が47個あるか確認する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span><span class="p">[</span><span class="s">'都道府県番号'</span><span class="p">].</span><span class="n">nunique</span><span class="p">()</span></code></pre></figure>

<h3 id="法人番号の列内のnanの総数を出す">法人番号の列内のNaNの総数を出す</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span><span class="p">[</span><span class="s">'法人番号'</span><span class="p">].</span><span class="n">isnull</span><span class="p">().</span><span class="nb">sum</span><span class="p">()</span></code></pre></figure>

<h3 id="nan-を-9999-で埋めるfillna9999-で行う">NaN を 9999 で埋める　fillna(9999) で行う</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span><span class="p">[</span><span class="s">'法人番号'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'法人番号'</span><span class="p">].</span><span class="n">fillna</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span></code></pre></figure>

<h3 id="申請日の列の型をdatetime-型dtypem8nsにする">申請日の列の型をdatetime 型　dtype(‘&lt;M8[ns]’)にする</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span><span class="p">[</span><span class="s">'申請日'</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'申請日'</span><span class="p">])</span></code></pre></figure>

<h3 id="法人番号で重複排除する">法人番号で重複排除する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s">'法人番号'</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s">'first'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="法人名の処理する前にオリジナルのデータを取っておく">法人名の処理する前にオリジナルのデータを取っておく</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span><span class="p">[</span><span class="s">'法人名オリジナル'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'法人名'</span><span class="p">].</span><span class="n">copy</span><span class="p">()</span></code></pre></figure>

<h3 id="法人名についている空白を埋める">法人名についている空白を埋める</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span><span class="p">[</span><span class="s">'法人名'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'法人名'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"　"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span></code></pre></figure>

<h3 id="sql-db名r3_61_227052by137_emp_num_r4db---sql-table名-r3_61_227052by137_tab-を作成する">SQL DB名：r3_61_227052by137_emp_num_r4.db  <br> SQL Table名： r3_61_227052by137_tab を作成する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="n">dbname</span> <span class="o">=</span> <span class="s">'r3_61_227052by137_emp_num_r4.db'</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">df</span><span class="p">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s">'r3_61_227052by137_tab'</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s">'replace'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="sql-ヒアドキュメントサンプル">SQL ヒアドキュメントサンプル</h3>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="n">query</span> <span class="o">=</span> <span class="nv">"</span><span class="se">""</span><span class="nv">
    SELECT 
            "</span><span class="err">法人名</span><span class="nv">", 
            "</span><span class="err">都道府県名</span><span class="nv">",
            "</span><span class="err">労働者総数</span><span class="nv">",
            "</span><span class="err">産業大分類名</span><span class="nv">",
            "</span><span class="err">法人番号</span><span class="nv">"
    FROM    "</span><span class="n">r3_61_227052by137_tab</span><span class="nv">"
    WHERE   "</span><span class="err">法人名</span><span class="nv">" 
    IN      (    
            '北海道信用金庫',
            '株式会社エスピー工研'
            )
  </span><span class="se">""</span><span class="nv">"</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="sql-ヒアドキュメントメインquery">SQL ヒアドキュメントメインQuery</h3>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="n">query</span> <span class="o">=</span> <span class="nv">"</span><span class="se">""</span><span class="nv">
    SELECT 
            "</span><span class="err">法人名</span><span class="nv">", 
            "</span><span class="err">適用事業所番号</span><span class="nv">",
            "</span><span class="err">法人番号</span><span class="nv">", 
            "</span><span class="err">住所</span><span class="nv">",
            "</span><span class="err">定年有無</span><span class="nv">" ,
            "</span><span class="err">定年年齢</span><span class="nv">", 
            "</span><span class="err">継続雇用</span><span class="o">-</span><span class="err">希望者最低年齢</span><span class="nv">", 
            "</span><span class="err">労働者総数レンジ</span><span class="nv">", 
            "</span><span class="err">産業大分類名</span><span class="nv">", 
            "</span><span class="err">都道府県名</span><span class="nv">"
    FROM    "</span><span class="n">r3_61_227052by137_tab</span><span class="nv">"
    WHERE   "</span><span class="err">定年有無</span><span class="nv">" == 2 OR
            "</span><span class="err">定年年齢</span><span class="nv">" &gt;= 70 OR
            "</span><span class="err">継続雇用</span><span class="o">-</span><span class="err">希望者最低年齢</span><span class="nv">" &gt;= 70 AND
            "</span><span class="err">産業中分類コード</span><span class="nv">" &lt;&gt; 94 AND
            "</span><span class="err">産業中分類コード</span><span class="nv">" &lt;&gt; 97 AND
            "</span><span class="err">産業中分類コード</span><span class="nv">" &lt;&gt; 98  
  </span><span class="se">""</span><span class="nv">"</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="display-df-のフォーマットを指定する">display df のフォーマットを指定する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="n">format_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s">'str%'</span><span class="p">:</span> <span class="s">'{:.1%}'</span><span class="p">,</span>
               <span class="s">'法人番号'</span><span class="p">:</span> <span class="s">'{:.0f}'</span><span class="p">,</span> 
               <span class="s">'定年到達者総数-65歳未満'</span><span class="p">:</span> <span class="s">'{:.0f}'</span><span class="p">,</span>
               <span class="s">'定年退職者数（継続雇用希望なし）-65歳未満'</span><span class="p">:</span> <span class="s">'{:.0f}'</span><span class="p">,</span>
               <span class="s">'継続雇用者数-65歳未満'</span><span class="p">:</span> <span class="s">'{:.0f}'</span>
              <span class="p">}</span>
<span class="n">df</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">format_dict</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="sql-query-サンプル">SQL query サンプル</h3>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="n">dbname</span> <span class="o">=</span> <span class="n">dbname</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="k">connect</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="k">cursor</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">cur</span><span class="p">.</span><span class="k">close</span><span class="p">()</span>
<span class="n">conn</span><span class="p">.</span><span class="k">close</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="read-excel-file-ファイル名とシート名とindexとするカラムを指定する-excelにインデクスがない場合はindex_colnone-を指定する">Read EXCEL file ファイル名とシート名とIndexとするカラムを指定する。 EXCELにインデクスがない場合は　<code class="highlighter-rouge">index_col=None</code> を指定する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">xlsx</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">ExcelFile</span><span class="p">(</span><span class="s">'基準データ2023.xlsx'</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">xlsx</span><span class="p">,</span> <span class="s">'data_2023'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">'idx'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="読み込んだdfからヒートマップを作成">読み込んだdfからヒートマップを作成</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">'figure.figsize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span>
<span class="n">sns</span><span class="p">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'BuGn'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">'employment1.png'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="インデックスjoin">インデックスJoin</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df12</span> <span class="o">=</span> <span class="n">df1</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s">'_2'</span><span class="p">)</span></code></pre></figure>

<h3 id="カラムmean-の値の大きい順-ascending--false-でソートする">カラム”mean” の値の大きい順 ascending = False でソートする</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s">"mean"</span><span class="p">],</span> <span class="n">ascending</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span></code></pre></figure>

<h3 id="カラム名産業大分類名で構成比を成型して表示する">カラム名　産業大分類名で構成比を成型して表示する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="n">col_name</span> <span class="o">=</span> <span class="s">'産業大分類名'</span>
<span class="n">tab</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">].</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">tab</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
<span class="n">tab</span> <span class="o">=</span> <span class="n">tab</span><span class="p">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
<span class="n">tab</span><span class="p">[</span><span class="s">'構成比'</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">/</span> <span class="n">tab</span><span class="p">[</span><span class="n">col_name</span><span class="p">].</span><span class="nb">sum</span><span class="p">())</span>
<span class="n">tab</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col_name</span><span class="p">:</span> <span class="s">'会社数'</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">format_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">'構成比'</span><span class="p">:</span> <span class="s">'{:.1%}'</span><span class="p">}</span>
<span class="n">display</span><span class="p">(</span><span class="n">tab</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">format_dict</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="csv-file-read">CSV file read</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">codecs</span>
<span class="k">with</span> <span class="n">codecs</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="s">"WA_Fn-UseC_-HR-Employee-Attrition.csv"</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span><span class="s">"r"</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span><span class="s">"utf-8"</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">"ignore"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span><span class="s">","</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="count-plot-サンプル">Count Plot サンプル</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="c1"># matplotlibのグラフをRetinaの高解像度で表示する
</span><span class="o">%</span><span class="n">config</span> <span class="n">InlineBackend</span><span class="p">.</span><span class="n">figure_formats</span> <span class="o">=</span> <span class="p">{</span><span class="s">'png'</span><span class="p">,</span> <span class="s">'retina'</span><span class="p">}</span>
<span class="c1"># Jupyter Notebookの中で作図した画像を表示させる
</span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="c1"># matplotlib をインポートする
</span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="c1"># 図のサイズを12inch x 12inch = 864px X 864px にする
</span><span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">'figure.figsize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span>
<span class="c1"># 日本語タイトルのため、japanizeをインポートする
</span><span class="kn">import</span> <span class="nn">japanize_matplotlib</span>
<span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">'font.family'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'IPAexGothic'</span>
<span class="c1"># 列を縦にする
# plt.xticks(rotation=90)
</span><span class="n">col_name</span> <span class="o">=</span> <span class="s">'YearsAtCompany'</span>
<span class="n">sns</span><span class="p">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">col_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s">'hls'</span><span class="p">)</span>
<span class="c1">#seaborn countplotを設定し、変数axとしてAnnotationを上書できるようにする
</span><span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">col_name</span><span class="p">,</span> 
                   <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="p">)</span>
<span class="c1"># Annotation を設定する
</span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">.</span><span class="n">patches</span><span class="p">:</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">format</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">get_height</span><span class="p">(),</span> <span class="s">'.0f'</span><span class="p">),</span> 
                   <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">p</span><span class="p">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> 
                    <span class="n">p</span><span class="p">.</span><span class="n">get_height</span><span class="p">()),</span> 
                    <span class="n">ha</span> <span class="o">=</span> <span class="s">'center'</span><span class="p">,</span> 
                    <span class="n">va</span> <span class="o">=</span> <span class="s">'center'</span><span class="p">,</span> 
                    <span class="n">xytext</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> 
                    <span class="n">textcoords</span> <span class="o">=</span> <span class="s">'offset points'</span><span class="p">,</span>
                    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s">'blue'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><img src="./Pandas, Python 慣用句_files/countplot1.png" alt="countplot"><br></p>

<h3 id="openpyxl-でexcel-file-のシート名を確認する">Openpyxl でExcel file のシート名を確認する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="c1"># ライブラリを読み込む
</span><span class="kn">import</span> <span class="nn">openpyxl</span> <span class="k">as</span> <span class="n">xl</span>
<span class="kn">import</span> <span class="nn">win32com.client</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">filename</span> <span class="o">=</span> <span class="s">'61_matching_lisr_winner_1221_v2.xlsx'</span>
<span class="n">wb</span> <span class="o">=</span> <span class="n">xl</span><span class="p">.</span><span class="n">load_workbook</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">wb</span><span class="p">.</span><span class="n">sheetnames</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="データフレーム-df-dt-を横に結合させる">データフレーム df, dt を横に結合させる</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">dt</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span></code></pre></figure>

<h3 id="都道府県番号都道府県名を一つの要素としてカラム名都道府県部分を都道府県番号と都道府県名に分割した新しいデータフレームdtを作成する">都道府県番号；都道府県名を一つの要素としてカラム名「都道府県」部分を、<br>「都道府県番号」と「都道府県名」に分割した新しいデータフレーム「dt」を作成する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="n">df</span><span class="p">[</span><span class="s">'new'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'都道府県'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">':'</span><span class="p">)</span>
<span class="n">np_array</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'new'</span><span class="p">].</span><span class="n">values</span>
<span class="n">np_list</span> <span class="o">=</span> <span class="n">np_array</span><span class="p">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np_list</span><span class="p">)</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'都道府県番号'</span><span class="p">,</span> <span class="s">'都道府県名'</span><span class="p">]</span>
<span class="n">dt</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cols</span>
<span class="n">display</span><span class="p">(</span><span class="n">dt</span><span class="p">.</span><span class="n">head</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="カラム名nameをインデクスに変える">カラム名「name」をインデクスに変える</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'name'</span><span class="p">)</span></code></pre></figure>

<h3 id="元のインデクス値をインデクスに戻すリセットする">元のインデクス値をインデクスに戻す（リセットする）</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">reset_index</span><span class="p">()</span></code></pre></figure>

<h3 id="列間を比較しその結果を-19-で出す">列間を比較し、その結果を 1\9 で出す</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre><span class="c1"># 必要なモジュールをインポートします
</span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="c1"># 演習用のデータフレームを作成します。
# ２番目の北海道と宮城県の顧客番号はint型でその他はstr型でデータフレームを作成
</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">({</span> <span class="s">'社員番号'</span><span class="p">:</span> <span class="p">[</span><span class="s">'01285679'</span><span class="p">,</span> <span class="s">'01340788'</span><span class="p">,</span> <span class="s">'02123782'</span><span class="p">,</span> <span class="s">'03541976'</span><span class="p">,</span> <span class="s">'04297411'</span><span class="p">,</span> <span class="s">'13299899'</span><span class="p">,</span> <span class="s">'30144450'</span><span class="p">,</span> <span class="s">'47339981'</span><span class="p">],</span>
                   <span class="s">'記録 列A'</span><span class="p">:</span>   <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span>
                   <span class="s">'報告 列B'</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">]},</span>
                    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>
<span class="c1"># データフレームを表示します
</span><span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func_row_check</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="s">"""
    列間を比較する

    引数:
        row['col1']: 比較したい列名 col1
        row['col2']: 比較したいもう一つの列名 col2

    Returns:
        1 : 一致
        9 : 不一致
    """</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s">'記録 列A'</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s">'報告 列B'</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">9</span>

<span class="n">df</span><span class="p">[</span><span class="s">'結果'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">func_row_check</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="カテゴリ毎に人数出して整形する">カテゴリ毎に人数出して、整形する</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="n">cat</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col4</span><span class="p">].</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">cat</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
<span class="n">cat</span> <span class="o">=</span> <span class="n">cat</span><span class="p">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="n">col4</span><span class="p">)</span>
<span class="n">cat</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col4</span><span class="p">:</span> <span class="s">'人数'</span><span class="p">},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p><img src="./Pandas, Python 慣用句_files/str_num1.png" alt="str_number"><br></p>

<h3 id="カテゴリ集計を円グラフにする">カテゴリ集計を円グラフにする</h3>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="n">tot</span> <span class="o">=</span> <span class="n">cat</span><span class="p">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>
<span class="n">sizes</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s">'人数'</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">cat</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">fix1</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s">'pastel'</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
<span class="n">ax1</span><span class="p">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s">'%1.1f%%'</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>

<span class="n">ax1</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'equal'</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">'申し込み者属性'</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'black'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="spss-データの読み取りカテゴリカルデータでデータフレームを作成">SPSS データの読み取り　カテゴリカルデータでデータフレームを作成</h3>
<p>SPSS データは、ラベル名付きとラベル名なし（数値）の二種類をシートを分割して表示している</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_spss</span><span class="p">(</span><span class="s">'SPSSデータ20230405.sav'</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">convert_categoricals</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></figure>

<h3 id="sql-here-documens">SQL here documens</h3>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">query</span> <span class="o">=</span> <span class="nv">"</span><span class="se">""</span><span class="nv">
    SELECT "</span><span class="err">法人名</span><span class="nv">", "</span><span class="err">適用事業所番号</span><span class="nv">","</span><span class="err">定年年齢</span><span class="nv">", "</span><span class="err">継続雇用制度</span><span class="nv">","</span><span class="err">労働者総数</span><span class="nv">","</span><span class="err">労働者総数レンジ</span><span class="nv">", 
            "</span><span class="err">継続雇用</span><span class="o">-</span><span class="err">希望者最低年齢</span><span class="nv">", "</span><span class="err">継続雇用</span><span class="o">-</span><span class="err">基準最高年齢</span><span class="nv">", "</span><span class="mi">60</span><span class="err">〜</span><span class="mi">64</span><span class="err">歳</span><span class="nv">", "</span><span class="mi">65</span><span class="err">〜</span><span class="mi">69</span><span class="err">歳</span><span class="nv">", "</span><span class="mi">70</span><span class="err">歳以上</span><span class="nv">", 
            "</span><span class="err">都道府県名</span><span class="nv">", "</span><span class="err">都道府県番号</span><span class="nv">","</span><span class="err">産業大分類名</span><span class="nv">","</span><span class="err">産業大分類コード</span><span class="nv">","</span><span class="err">事業具体的内容</span><span class="nv">"
    FROM   r4_61_235875by137_tab
    WHERE  "</span><span class="err">適用事業所番号</span><span class="nv">" 
    IN (    
        '07040018408',
        '38046133551',
        '19041009509',
        '24031041347',
        '28050009587',
        '03010054500',
        '23090023395',
        '35030028271',
        '47020004572',
        '45032017649',
        '20040019386',
        '41061002192',
        '20040026435',
        '26071017321',
        '23066143807',
        '23044415753',
        '17010005343',
        '17020009844',
        '08011007115',
        '14015254513',
        '13086280459'
        )
 </span><span class="se">""</span><span class="nv">"</span>

<span class="o">#</span><span class="n">dbname</span> <span class="o">=</span> <span class="s1">'r4_61_235875by137_0118r5.db'</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="k">connect</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="k">cursor</span><span class="p">()</span>

<span class="o">#</span> <span class="n">db</span><span class="err">を</span><span class="n">pandas</span><span class="err">で読み出す。</span>
<span class="o">#</span> <span class="k">WHERE</span> <span class="err">で条件に合致した要素のみを読み込み、それを</span><span class="n">DataFrame</span> <span class="err">に格納する</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span></code></pre></figure>

<h3 id="docker-グループにユーザuserを追加する">docker グループにユーザ(user)を追加する</h3>

<blockquote>
  <p>$ docker ps<br>
Got permission denied while trying to connect to the Docker daemon 
socket at unix:///var/run/docker.sock: 
Get http://%2Fvar%2Frun%2Fdocker.sock/v1.39/containers/json: 
dial unix /var/run/docker.sock: connect: permission denied</p>
</blockquote>

<figure class="highlight"><pre><code class="language-vb" data-lang="vb"><span class="n">user@KENKYU01</span><span class="p">:</span><span class="err">~$</span> <span class="n">sudo</span> <span class="n">gpasswd</span> <span class="o">-</span><span class="n">a</span> <span class="n">user</span> <span class="n">sudo</span>

<span class="err">[</span><span class="n">sudo</span><span class="err">]</span> <span class="n">password</span> <span class="n">for</span> <span class="n">user</span><span class="p">:</span>
<span class="n">Adding</span> <span class="n">user</span> <span class="n">user</span> <span class="n">to</span> <span class="n">group</span> <span class="n">sudo</span></code></pre></figure>

<h3 id="docker-conainer--からminimal-thema-でpublishbundle-exec-jekyll-server--h-0000する">docker conainer  からminimal thema でPublish(bundle exec jekyll server -H 0.0.0.0)する</h3>

<figure class="highlight"><pre><code class="language-vb" data-lang="vb"><span class="err">$</span> <span class="n">winpty</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">it</span> <span class="o">--</span><span class="n">name</span> <span class="n">docker_jekyll</span>     <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="err">$</span><span class="n">PWD</span><span class="o">/</span><span class="n">_config</span><span class="p">.</span><span class="n">yml</span><span class="p">:</span><span class="o">//</span><span class="n">work</span><span class="o">/</span><span class="n">_config</span><span class="p">.</span><span class="n">yml</span>     <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="err">$</span><span class="n">PWD</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span><span class="p">:</span><span class="o">//</span><span class="n">work</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span>     <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="err">$</span><span class="n">PWD</span><span class="o">/</span><span class="n">_data</span><span class="o">/</span><span class="p">:</span><span class="o">//</span><span class="n">work</span><span class="o">/</span><span class="n">_data</span><span class="o">/</span>     <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="err">$</span><span class="n">PWD</span><span class="o">/</span><span class="n">_posts</span><span class="o">/</span><span class="p">:</span><span class="o">//</span><span class="n">work</span><span class="o">/</span><span class="n">_posts</span><span class="o">/</span>     <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="err">$</span><span class="n">PWD</span><span class="o">/</span><span class="n">_site</span><span class="o">/</span><span class="p">:</span><span class="o">//</span><span class="n">work</span><span class="o">/</span><span class="n">_site</span><span class="o">/</span>     <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="err">$</span><span class="n">PWD</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="p">:</span><span class="o">//</span><span class="n">work</span><span class="o">/</span><span class="n">images</span><span class="o">/</span>     <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="err">$</span><span class="n">PWD</span><span class="o">/</span><span class="n">assets</span><span class="o">/</span><span class="p">:</span><span class="o">//</span><span class="n">work</span><span class="o">/</span><span class="n">assets</span><span class="o">/</span>     <span class="o">-</span><span class="n">p</span> <span class="mi">4000</span><span class="p">:</span><span class="mi">4000</span>     <span class="o">-</span><span class="n">w</span> <span class="o">//</span><span class="n">work</span>     <span class="n">docker_jekyll</span>     <span class="n">bundle</span> <span class="n">exec</span> <span class="n">jekyll</span> <span class="n">serve</span> <span class="o">-</span><span class="n">H</span> <span class="mf">0.0</span><span class="p">.</span><span class="err">0.0</span></code></pre></figure>

<h3 id="グループの追加ができたことを確認するログアウトすること">グループの追加ができたことを確認する。ログアウトすること。</h3>

<figure class="highlight"><pre><code class="language-vb" data-lang="vb"><span class="n">user@KENKYU01</span><span class="p">:</span><span class="err">~$</span> <span class="n">id</span> <span class="n">user</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1000</span><span class="p">(</span><span class="n">user</span><span class="p">),</span><span class="mi">27</span><span class="p">(</span><span class="n">sudo</span><span class="p">),</span><span class="mi">1001</span><span class="p">(</span><span class="n">docker</span><span class="p">)</span>
<span class="n">user@KENKYU01</span><span class="p">:</span><span class="err">~$</span> <span class="n">exit</span>
<span class="n">logout</span></code></pre></figure>

<h3 id="sql-文条件追加-andornot">SQL 文　条件追加 and/or/not</h3>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="n">format_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'str%'</span><span class="p">:</span> <span class="s1">'{:.1%}'</span><span class="p">,</span>
               <span class="s1">'法人番号'</span><span class="p">:</span> <span class="s1">'{:.0f}'</span> <span class="p">,</span>
               <span class="s1">'定年到達者総数-65歳未満'</span><span class="p">:</span> <span class="s1">'{:.0f}'</span><span class="p">,</span>
               <span class="s1">'定年退職者数（継続雇用希望なし）-65歳未満'</span><span class="p">:</span> <span class="s1">'{:.0f}'</span><span class="p">,</span>
               <span class="s1">'継続雇用者数-65歳未満'</span><span class="p">:</span> <span class="s1">'{:.0f}'</span> <span class="p">}</span>

<span class="n">query</span> <span class="o">=</span> <span class="nv">"</span><span class="se">""</span><span class="nv">
    SELECT "</span><span class="err">法人名</span><span class="nv">", "</span><span class="err">適用事業所番号</span><span class="nv">","</span><span class="err">法人番号</span><span class="nv">", "</span><span class="err">住所</span><span class="nv">","</span><span class="err">定年有無</span><span class="nv">" ,"</span><span class="err">定年年齢</span><span class="nv">", "</span><span class="err">継続雇用</span><span class="o">-</span><span class="err">希望者最低年齢</span><span class="nv">", "</span><span class="err">労働者総数レンジ</span><span class="nv">", "</span><span class="err">労働者総数</span><span class="nv">" ,"</span><span class="err">産業大分類名</span><span class="nv">", "</span><span class="err">都道府県名</span><span class="nv">"
    FROM "</span><span class="n">r3_61_227051by137_tab</span><span class="nv">"
    WHERE "</span><span class="err">定年有無</span><span class="nv">" == 2 OR
    "</span><span class="err">定年年齢</span><span class="nv">" &gt;= 70 OR
    "</span><span class="err">継続雇用</span><span class="o">-</span><span class="err">希望者最低年齢</span><span class="nv">" &gt;= 70 AND
    "</span><span class="err">産業中分類コード</span><span class="nv">" &lt;&gt; 94 AND
    "</span><span class="err">産業中分類コード</span><span class="nv">" &lt;&gt; 97 AND
    "</span><span class="err">産業中分類コード</span><span class="nv">" &lt;&gt; 98
  </span><span class="se">""</span><span class="nv">"</span>

<span class="n">dbname</span> <span class="o">=</span> <span class="n">dbname</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="k">connect</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="k">cursor</span><span class="p">()</span>
<span class="o">#</span> <span class="n">db</span><span class="err">を</span><span class="n">pandas</span><span class="err">で読み出す。</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">cur</span><span class="p">.</span><span class="k">close</span><span class="p">()</span>
<span class="n">conn</span><span class="p">.</span><span class="k">close</span><span class="p">()</span></code></pre></figure>


    </section>
  </article>
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="http://localhost:4000/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">© 2023 so-wi.com. Powered by <a href="https://jekyllrb.com/" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="./Pandas, Python 慣用句_files/main.min.js.ダウンロード"></script>
  <script defer="" src="https://use.fontawesome.com/releases/v5.8.2/js/all.js" integrity="sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH" crossorigin="anonymous"></script>










  

</body></html>